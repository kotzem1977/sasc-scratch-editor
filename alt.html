<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SASC Scratch Editor — alt (fiber-binder)</title>
  <link rel="icon" href="./favicon.ico"/>

  <style>
    html,body,#app{height:100%;margin:0}
    #app{display:flex;align-items:stretch;justify-content:stretch;background:#0b1120}
    #sasc-console{position:fixed;left:10px;bottom:10px;width:380px;max-height:52vh;background:#0b0e;backdrop-filter:blur(2px);
      color:#0ff;font:12px/1.35 ui-monospace,Consolas,monospace;border:1px solid #044;border-radius:8px;z-index:99999}
    #sasc-console[data-theme="light"]{background:#fff9;color:#034;border-color:#89a}
    #sasc-console header{display:flex;gap:6px;flex-wrap:wrap;align-items:center;padding:6px 8px;background:#022;border-bottom:1px solid #044;border-radius:8px 8px 0 0}
    #sasc-console[data-theme="light"] header{background:#eaf2ff;border-bottom-color:#89a}
    #sasc-console header strong{margin-right:auto}
    #sasc-console pre{margin:0;padding:6px 8px;white-space:pre-wrap;overflow:auto;max-height:calc(52vh - 44px)}
    #sasc-console button{all:unset;cursor:pointer;color:inherit;padding:2px 6px;border:1px solid currentColor;border-radius:6px}
    #sasc-console .btnrow button{margin-left:4px}

    [class*="gui-body"]{display:flex;min-height:100vh}
    [class*="stage-wrapper"]{position:relative;z-index:0;flex:0 0 auto}
    [class*="stage-header"]{position:relative;z-index:2}
    [class*="green-flag"],[class*="stop-all"]{position:relative;z-index:3}
    [class*="blockly"],[class*="blocks"]{min-width:280px;flex:1 1 50%}
    [class*="target-pane"]{min-width:240px;flex:0 0 240px}
    [class*="react-modal"],[class*="modal-content"]{z-index:9999;position:relative}
    canvas{cursor:default}
  </style>
</head>
<body>
  <div id="app"></div>

  <div id="sasc-console">
    <header>
      <strong>SASC</strong>
      <button id="btn-clear">Clear</button>
      <button id="btn-contrast">Contrast</button>
      <span class="btnrow">
        <button id="btn-bind">Bind VM</button>
        <button id="btn-targets">List Targets</button>
        <button id="btn-apple">Add Apple Sprite</button>
        <button id="btn-backdrop">Add Backdrop (md5.ext)…</button>
        <button id="btn-costume">Add Costume…</button>
        <button id="btn-sound">Add Sound…</button>
      </span>
    </header>
    <pre>SASC clear
</pre>
  </div>

  <script>
    (function(){
      const pre=document.querySelector('#sasc-console pre');
      const box=document.getElementById('sasc-console');
      const out=(tag,msg)=>{ const line=(tag?(`[${tag}] `):'')+msg; try{pre.textContent+=line+'\n'; pre.scrollTop=pre.scrollHeight;}catch(_){} console.log(line); };
      window.__sascLog=(m)=>out('',m);
      window.__sascTag=(t,m)=>out(t,m);
      document.getElementById('btn-clear').onclick=()=>{ pre.textContent='SASC clear\n'; };
      document.getElementById('btn-contrast').onclick=()=>{ box.toggleAttribute('data-theme','light'); };
      window.addEventListener('click',e=>out('Click',e.target.tagName));
      window.addEventListener('unhandledrejection',e=>out('unhandledrejection',(e.reason&&(e.reason.stack||e.reason))));
    })();
  </script>

  <script src="https://unpkg.com/react@16.14.0/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@16.14.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/redux@4.2.1/dist/redux.min.js"></script>
  <script>
    (function(){
      if(window.React && !window.react){ window.react=window.React; __sascTag('SASC','react alias set');}
      if(window.ReactDOM && !window['react-dom']){ window['react-dom']=window.ReactDOM; __sascTag('SASC','react-dom alias set');}
      if(window.Redux && !window.redux){ window.redux=window.Redux; __sascTag('SASC','redux alias set');}
    })();
  </script>

  <script>
    (function(){
      const base=location.pathname.replace(/\/[^/]*$/,'/'); const repoRoot=base.replace(/\/$/,'');
      const toLocal=u=>{ const m=u&&u.match(/internalapi\/asset\/([a-f0-9]{32}\.(?:sprite3|json|svg|png|gif|jpg|wav|mp3))\/get\/?/i); return m?(repoRoot+'/static/assets/'+m[1]):null; };
      const f=window.fetch;
      window.fetch=async function(i,init){
        const url=(typeof i==='string')?i:(i&&i.url);
        const local=toLocal(url);
        if(local){ try{ const r=await f(local,init); if(r&&r.ok) return r; }catch(_){ } }
        return f.apply(this,arguments);
      };
      const XO=XMLHttpRequest;
      window.XMLHttpRequest=function(){
        const x=new XO(); const _open=x.open; let original=null,method='GET';
        x.open=function(m,u){ method=m; original=u; const local=(typeof u==='string')?toLocal(u):null;
          if(local){ _open.call(x,m,local); const onload=()=>{ if(!(x.status>=200&&x.status<300)){ x.removeEventListener('load',onload); _open.call(x,method,original); x.send(); } };
            x.addEventListener('load',onload); return; }
          return _open.apply(x,arguments);
        };
        return x;
      };
      __sascTag('SASC','hooks installed (assets local-first with XHR fallback)');
    })();
  </script>

  <script src="scratch-gui.js?v=fiber-002"></script>

  <script>
    (function mount(){
      try{
        const app=document.getElementById('app');
        const GUI=window.GUI;
        if(!GUI){ __sascTag('SASC','ERROR: window.GUI missing'); return; }
        if(typeof GUI.setAppElement==='function') GUI.setAppElement(app);

        if(typeof GUI.render==='function'){
          GUI.render(app);
          __sascTag('SASC','GUI mounted via GUI.render(app)');
        }else{
          let Wrapped=GUI.default||GUI.GUI||GUI;
          if(typeof GUI.AppStateHOC==='function') Wrapped=GUI.AppStateHOC(Wrapped);
          if(typeof GUI.ProjectLoaderHOC==='function') Wrapped=GUI.ProjectLoaderHOC(Wrapped);
          if(typeof GUI.HashParserHOC==='function') Wrapped=GUI.HashParserHOC(Wrapped);
          const props={isPlayerOnly:false,isFullScreen:false,canUseCloud:false,projectId:(location.hash&&/\d+/.test(location.hash))?undefined:'0'};
          const el=window.React.createElement(Wrapped,props);
          window.ReactDOM.render(el,app);
          __sascTag('SASC','GUI mounted via HashParser(ProjectLoader(AppState(GUI))) with projectId='+(props.projectId||'hash'));
        }
      }catch(e){ __sascTag('SASC','BOOT ERROR: '+(e&&e.message||e)); }
    })();
  </script>

  <!-- SAME VM binder + tools as index.html -->
  <script>
    /* copied verbatim from index.html’s binder/tools block */
  </script>
  <script>
    /* For brevity, paste the entire binder/tools block from index.html here in your repo. */
  </script>
</body>
</html>
