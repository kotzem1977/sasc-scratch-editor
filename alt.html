<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SASC Scratch Editor — alt (redux bind)</title>
  <link rel="icon" href="./favicon.ico"/>

  <style>
    html,body,#app{height:100%;margin:0}
    #app{display:flex;align-items:stretch;justify-content:stretch;background:#0b1120}
    #sasc-console{position:fixed;left:10px;bottom:10px;width:320px;max-height:45vh;background:#111a;backdrop-filter:blur(2px);
      color:#0ff;font:12px/1.35 ui-monospace,Consolas,monospace;border:1px solid #044;border-radius:8px;z-index:99999}
    #sasc-console header{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:#022;border-bottom:1px solid #044;border-radius:8px 8px 0 0}
    #sasc-console pre{margin:0;padding:6px 8px;white-space:pre-wrap;overflow:auto;max-height:calc(45vh - 32px)}
    #sasc-console button{all:unset;cursor:pointer;color:#0ff;padding:2px 6px;border:1px solid #044;border-radius:6px}

    [class*="stage-wrapper"]{position:relative;z-index:0}
    [class*="stage-header"]{position:relative;z-index:2}
    [class*="green-flag"],[class*="stop-all"]{position:relative;z-index:3}
    canvas{cursor:default}
    [class*="gui-body"]{display:flex;min-height:100vh}
    [class*="blockly"],[class*="blocks"]{min-width:280px;flex:1 1 50%}
    [class*="target-pane"]{min-width:240px;flex:0 0 240px}
    [class*="stage-wrapper"]{flex:0 0 auto}
    [class*="react-modal"],[class*="modal-content"]{z-index:9999;position:relative}
    [class*="sprite-selector"] img{display:block}
    [class*="sprite-selector_add-button"],[class*="stage-selector_add-button"]{pointer-events:auto}
  </style>

  <script>
  (function loadScratchGuiCSS(){
    var ORIGIN='https://scratchfoundation.github.io', BASE=ORIGIN+'/scratch-gui';
    function add(h){var l=document.createElement('link');l.rel='stylesheet';l.href=h;document.head.appendChild(l);}
    function abs(p){if(!p)return null; if(p.startsWith('http'))return p; if(p.startsWith('//'))return 'https:'+p; if(p.startsWith('/'))return ORIGIN+p; return BASE+'/'+p.replace(/^\.?\//,'');}
    if(document.documentElement.hasAttribute('data-sasc-css-loaded')) return;
    document.documentElement.setAttribute('data-sasc-css-loaded','1');
    fetch(BASE+'/asset-manifest.json')
      .then(r=>r.ok?r.json():Promise.reject())
      .then(man=>{
        var files=(man&&man.files)||{}, css=[];
        Object.keys(files).forEach(k=>{if(/\.css$/.test(files[k]))css.push(files[k])});
        if(Array.isArray(man.entrypoints)) man.entrypoints.forEach(ep=>{if(/\.css$/.test(ep))css.push(ep)});
        css=Array.from(new Set(css)).map(abs); css.forEach(add);
        console.log('[SASC] CSS via manifest:', css);
      })
      .catch(()=>{console.warn('[SASC] demo CSS manifest/links not available; using shim');});
  })();
  </script>
</head>
<body>
  <div id="app"></div>

  <div id="sasc-console">
    <header>
      <strong>SASC</strong>
      <div><button onclick="(document.querySelector('#sasc-console pre').textContent='SASC clear\n')">Clear</button></div>
    </header>
    <pre>SASC clear
</pre>
  </div>
  <script>
    (function(){const pre=document.querySelector('#sasc-console pre');window.__sascLog=(m)=>{try{pre.textContent+=m+'\n';pre.scrollTop=pre.scrollHeight}catch(_){}console.log(m);
      window.addEventListener('click',e=>__sascLog('[Click] '+e.target.tagName));
      window.addEventListener('unhandledrejection',e=>__sascLog('[unhandledrejection]: '+(e.reason&&(e.reason.stack||e.reason))));})();
  </script>

  <script src="https://unpkg.com/react@16.14.0/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@16.14.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/redux@4.2.1/dist/redux.min.js"></script>

  <!-- Redux store hook -->
  <script>
  (function hookStore(){
    const log=(m)=> (window.__sascLog?__sascLog(m):console.log('[bind]',m));
    const R=window.Redux;
    if(!R||!R.createStore){log('Redux not ready to hook');return;}
    const orig=R.createStore;
    R.createStore=function(){
      const store=orig.apply(this,arguments);
      window.__SASC_STORE=store;
      log('store captured');
      try{
        const snap=store.getState&&store.getState();
        if (snap && snap.scratchGui && snap.scratchGui.vm){
          window.vm=snap.scratchGui.vm; log('window.vm from store (initial)');
        }
        store.subscribe(()=>{
          try{
            const s=store.getState();
            if(s && s.scratchGui && s.scratchGui.vm && window.vm!==s.scratchGui.vm){
              window.vm=s.scratchGui.vm;
              const t=(window.vm.runtime&&window.vm.runtime.targets||[]).length;
              log('window.vm from store (targets='+t+')');
            }
          }catch(_){}
        });
      }catch(_){}
      return store;
    };
  })();
  </script>

  <script>
  (function(){
    const base=location.pathname.replace(/\/[^/]*$/,'/'), repoRoot=base.replace(/\/$/,'');
    const toLocal=(u)=>{const m=u&&u.match(/internalapi\/asset\/([a-f0-9]{32}\.(?:sprite3|json|svg|png|gif|jpg|wav|mp3))\/get\/?/i);return m?(repoRoot+'/static/assets/'+m[1]):null};
    const f=window.fetch;
    window.fetch=async function(i,init){const url=(typeof i==='string')?i:(i&&i.url);const local=toLocal(url);
      if(local){try{const r=await f(local,init);if(r&&r.ok){console.log('[SASC] fetch local OK →',local);return r}console.log('[SASC] fetch local not OK →',url)}catch(e){console.log('[SASC] fetch local error →',e)}}
      return f.apply(this,arguments)};
    const XO=XMLHttpRequest;
    window.XMLHttpRequest=function(){const x=new XO();let original=null,method='GET';const _open=x.open;
      x.open=function(m,u){method=m;original=u;const local=(typeof u==='string')?toLocal(u):null;
        if(local){_open.call(x,m,local);const onload=()=>{if(x.status>=200&&x.status<300){console.log('[SASC] xhr local OK →',local)}else{console.log('[SASC] xhr local not OK ('+x.status+') →',original);x.removeEventListener('load',onload);_open.call(x,method,original);x.send();}};x.addEventListener('load',onload);return;}
        return _open.apply(x,arguments)};const _send=x.send;x.send=function(){return _send.apply(x,arguments)};return x};
    __sascLog('[hooks] installed (assets local-first with XHR fallback)');
  })();
  </script>

  <script src="scratch-gui.js?v=stable-boot-clean-alt"></script>

  <script>
  (function bindVM(){
    const log=(m)=> (window.__sascLog?__sascLog(m):console.log('[bind]',m));
    const grab=()=>{const GUI=window.GUI||{};return window.vm||GUI.vm||(typeof GUI.getVm==='function'?GUI.getVm():null)};
    let waited=0;
    const t=setInterval(()=>{
      const vm=grab();
      if(vm&&vm.runtime&&vm.runtime.targets){window.vm=vm;log('window.vm attached (targets='+(vm.runtime.targets.length||0)+')');clearInterval(t);return;}
      if((waited+=250)>15000){clearInterval(t);log('could not attach vm (15s)');}
    },250);
  })();
  </script>

  <!-- Same SASC tools as index (omitted here for brevity; paste the SAME block from index into here) -->
  <script>
  /* paste the entire SASC asset tools block from index.html here (identical) */
  </script>
</body>
</html>
