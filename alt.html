<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SASC Scratch Editor — alt (clean)</title>

  <style>
    html,body,#app{height:100%;margin:0}
    #app{display:flex;align-items:stretch;justify-content:stretch;background:#0b1120}
    #sasc-console{position:fixed;left:10px;bottom:10px;width:320px;max-height:45vh;background:#111a;backdrop-filter:blur(2px);
      color:#0ff;font:12px/1.35 ui-monospace,Consolas,monospace;border:1px solid #044;border-radius:8px;z-index:99999}
    #sasc-console header{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:#022;border-bottom:1px solid #044;border-radius:8px 8px 0 0}
    #sasc-console pre{margin:0;padding:6px 8px;white-space:pre-wrap;overflow:auto;max-height:calc(45vh - 32px)}
    #sasc-console button{all:unset;cursor:pointer;color:#0ff;padding:2px 6px;border:1px solid #044;border-radius:6px}

    /* Safety net */
    #app [class*="stage-wrapper"] { position: relative; z-index: 0; }
    #app [class*="controls"], #app [class*="green--flag"], #app [class*="stop-all"] { position: relative; z-index: 3; }
    [class*="modal-overlay"], [class*="modal-content"] { z-index: 9999 !important; }
    #app canvas { cursor: default; }
  </style>
</head>
<body>
  <div id="app"></div>

  <div id="sasc-console"><header><strong>SASC</strong><div>
    <button onclick="(document.querySelector('#sasc-console pre').textContent='SASC clear\n')">Clear</button></div></header><pre>SASC clear
</pre></div>
  <script>
    (function(){const pre=document.querySelector('#sasc-console pre');window.__sascLog=(m)=>{try{pre.textContent+=m+'\n';pre.scrollTop=pre.scrollHeight}catch(_){}console.log(m)};
      window.addEventListener('click',e=>__sascLog('[Click] '+e.target.tagName));
      window.addEventListener('unhandledrejection',e=>__sascLog('[unhandledrejection]: '+(e.reason&&(e.reason.stack||e.reason))));
    })();
  </script>

  <!-- React 16.14 UMD -->
  <script src="https://unpkg.com/react@16.14.0/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@16.14.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/redux@4.2.1/dist/redux.min.js"></script>

  <!-- asset hooks (local-first with fallback) -->
  <script>
  (function(){
    const base = location.pathname.replace(/\/[^/]*$/, '/'); // /<user>/<repo>/
    const repoRoot = base.replace(/\/$/, '');
    const toLocalAsset = (u) => {
      const m = u && u.match(/internalapi\/asset\/([a-f0-9]{32}\.(?:sprite3|json|svg|png|gif|jpg))\/get\/?/i);
      return m ? (repoRoot + '/static/assets/' + m[1]) : null;
    };

    // --- fetch: try local, then ORIGINAL ---
    const f = window.fetch;
    window.fetch = async function(input, init){
      const url = (typeof input === 'string') ? input : (input && input.url);
      const local = toLocalAsset(url);
      if (local){
        try {
          const r = await f(local, init);
          if (r && r.ok) {
            console.log('[SASC] fetch local OK →', local);
            return r;
          }
          console.log('[SASC] fetch local not OK ('+(r && r.status)+') → falling back:', url);
        } catch (e) {
          console.log('[SASC] fetch local error → falling back:', e);
        }
      }
      return f.apply(this, arguments);
    };

    // --- XHR: try local, then retry ORIGINAL if local not 2xx ---
    const XO = window.XMLHttpRequest;
    window.XMLHttpRequest = function(){
      const x = new XO();
      let original = null;
      let method   = 'GET';

      const _open = x.open;
      x.open = function(m,u){
        method = m;
        original = u;
        const local = (typeof u === 'string') ? toLocalAsset(u) : null;

        if (local){
          _open.call(x, m, local);
          const onload = function(){
            if (x.status >= 200 && x.status < 300) {
              console.log('[SASC] xhr local OK →', local);
            } else {
              console.log('[SASC] xhr local not OK ('+x.status+') → retrying ORIGINAL:', original);
              x.removeEventListener('load', onload);
              _open.call(x, method, original);
              x.send();
            }
          };
          x.addEventListener('load', onload);
          return;
        }
        return _open.apply(x, arguments);
      };

      const _send = x.send;
      x.send = function(){ return _send.apply(x, arguments); };

      return x;
    };

    console.log('[hooks] installed (assets local-first with XHR fallback)');
  })();
  </script>

  <!-- Your GUI bundle -->
  <script src="scratch-gui.js?v=stable-boot-clean-alt"></script>

  <!-- Boot (default projectId=0) -->
  <script>
    (function(){
      try{
        const app=document.getElementById('app');
        const GUI=window.GUI;
        if (!GUI) { __sascLog('ERROR: window.GUI missing'); return; }
        if (typeof GUI.setAppElement === 'function') GUI.setAppElement(app);

        if (typeof GUI.render === 'function') {
          GUI.render(app);
          __sascLog('GUI mounted via GUI.render(app)');
          return;
        }

        let Wrapped = GUI.default || GUI.GUI || GUI;
        if (typeof GUI.AppStateHOC === 'function') Wrapped = GUI.AppStateHOC(Wrapped);
        if (typeof GUI.ProjectLoaderHOC === 'function') Wrapped = GUI.ProjectLoaderHOC(Wrapped);
        if (typeof GUI.HashParserHOC === 'function') Wrapped = GUI.HashParserHOC(Wrapped);

        const el = window.React.createElement(Wrapped, {
          isPlayerOnly:false,
          isFullScreen:false,
          canUseCloud:false,
          projectId: (location.hash && /\d+/.test(location.hash)) ? undefined : '0'
        });
        window.ReactDOM.render(el, app);
        __sascLog('GUI mounted via HashParser(ProjectLoader(AppState(GUI))) with default projectId=0');

        let waited=0;
        const t=setInterval(()=>{try{
          const vm=window.vm||(GUI&&GUI.vm);
          if(vm&&vm.runtime&&vm.runtime.targets&&vm.runtime.targets.length){
            __sascLog('[VM] ready: '+vm.runtime.targets.length+' targets');
            clearInterval(t);
          }
        }catch(_){} if((waited+=250)>15000){clearInterval(t);__sascLog('VM not ready in time');}},250);
      }catch(e){__sascLog('BOOT ERROR: '+(e&&e.message)); console.error(e);}
    })();
  </script>
</body>
</html>
