<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="google" value="notranslate"/>
  <link rel="shortcut icon" href="static/favicon.ico"/>
  <title>Scratch 3.0 GUI (alt) — SA SchoolCoding</title>
  <!-- SASC v4 -->

  <script src="https://unpkg.com/react@16.14.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16.14.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/redux@4.2.1/dist/redux.min.js" crossorigin></script>

  <style>
    html,body{height:100%;margin:0}
    body{overflow:hidden;background:#0f0f0f}
    #app{height:100%}
    #sasc-console{
      position:fixed;left:12px;bottom:12px;z-index:99999;
      font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      color:#eee;background:#111;opacity:.95;border:1px solid #333;border-radius:8px;
      max-width:60vw;max-height:40vh;overflow:auto;padding:8px 10px;box-shadow:0 6px 16px rgba(0,0,0,.5)
    }
    #sasc-console b{color:#9ad}
    #sasc-console .err{color:#f99}
    #sasc-console .ok{color:#9f9}
  </style>

  <script>
  /* identical to index.html’s script except bundle query at the end differs */
  (function SASC_boot(){
    const box = document.createElement('div');
    box.id = 'sasc-console';
    box.innerHTML = '<b>[SASC]</b> console ready<br/>';
    function log(){ try{ box.innerHTML += Array.from(arguments).map(a=>String(a)).join(' ') + '<br/>'; console.log('[SASC]', ...arguments);}catch(_){} }
    function logErr(){ try{ box.innerHTML += '<span class="err">' + Array.from(arguments).map(a=>String(a)).join(' ') + '</span><br/>'; console.error('[SASC]', ...arguments);}catch(_){} }
    function logOk(){ try{ box.innerHTML += '<span class="ok">' + Array.from(arguments).map(a=>String(a)).join(' ') + '</span><br/>'; console.log('[SASC]', ...arguments);}catch(_){} }

    window.addEventListener('error', e => logErr('onerror:', e.message||e));
    window.addEventListener('unhandledrejection', e => logErr('unhandledrejection:', e.reason||e));
    document.addEventListener('click', e => log('[Click]', e.target.tagName));
    document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(box));
    if (document.body) document.body.appendChild(box);

    if (window.React && !window.react) { window.react = window.React; log('react alias set'); }
    if (window.ReactDOM && !window['react-dom']) { window['react-dom'] = window.ReactDOM; log('react-dom alias set'); }
    if (window.Redux && !window.redux) { window.redux = window.Redux; log('redux alias set'); }

    log('href:', location.href);
    log('React present:', !!window.react, 'version:', window.react && window.react.version);
    log('ReactDOM present:', !!window['react-dom']);
    log('Redux present:', !!window.redux);

    (function(){
      const origFetch = window.fetch && window.fetch.bind(window);
      if (!origFetch) return;
      const basePath = location.pathname.replace(/\/[^/]*$/, '/');
      const ownerRepo = basePath.split('/').filter(Boolean).slice(0,2);
      const repoPath = '/' + ownerRepo.join('/');

      function toLocal(urlStr){
        const u = new URL(urlStr, location.origin + basePath);
        if (u.pathname.startsWith('/libraries/')) {
          u.pathname = (repoPath + u.pathname).replace(/\/{2,}/g,'/');
        } else if (u.pathname.startsWith('/static/') || u.pathname.startsWith('/chunks/')) {
          u.pathname = (basePath.replace(/\/$/, '') + u.pathname).replace(/\/{2,}/g,'/');
        } else if (u.pathname.startsWith('/internalapi/asset/')) {
          const m = u.pathname.match(/^\/internalapi\/asset\/([^/]+)\/get\/?$/);
          if (m) u.pathname = (basePath + 'static/assets/' + m[1]).replace(/\/{2,}/g,'/');
        } else if (u.pathname.startsWith('internalapi/asset/')) {
          const m = u.pathname.match(/^internalapi\/asset\/([^/]+)\/get\/?$/);
          if (m) u.pathname = (basePath + 'static/assets/' + m[1]).replace(/\/{2,}/g,'/');
        }
        return u.toString();
      }

      window.fetch = function(input, init){
        try{
          if (typeof input === 'string') {
            const fixed = toLocal(input);
            if (fixed !== input) log('[fetch]', input, '→', fixed);
            return origFetch(fixed, init);
          } else if (input && typeof input.url === 'string') {
            const fixed = toLocal(input.url);
            if (fixed !== input.url) {
              log('[fetch]', input.url, '→', fixed);
              input = new Request(fixed, input);
            }
            return origFetch(input, init);
          }
        }catch(e){ logErr('[fetch] rewrite error', e); }
        return origFetch(input, init);
      };
    })();

    function mountGUI(){
      const el = document.getElementById('app');
      const R = window.React || window.react;
      const RD = window.ReactDOM || window['react-dom'];
      const cands = ['ScratchGUI','scratchGui','GUI','App','default'];
      const wins = [window];
      if (window.Scratch) wins.push(window.Scratch);
      if (window.scratch) wins.push(window.scratch);

      function tryRenderComponent(comp, label){
        try{ RD.render(R.createElement(comp, {}), el); logOk('Mounted GUI as component via', label); return true; }
        catch(e){ logErr('Component mount failed via', label, ':', e && (e.stack||e.message||e)); return false; }
      }
      function tryCallRender(obj, label){
        try{ if (typeof obj.render === 'function') { obj.render(el); logOk('Mounted GUI via', label, '.render(el)'); return true; } }
        catch(e){ logErr('render(el) failed on', label, ':', e && (e.stack||e.message||e)); }
        return false;
      }

      for (const root of wins){
        if (!root) continue;
        for (const k of cands){
          const v = root[k];
          if (!v) continue;
          if (typeof v === 'object' && typeof v.render === 'function') { if (tryCallRender(v, `window.${k}`)) return true; }
          if (v && typeof v === 'object' && typeof v.default === 'object' && typeof v.default.render === 'function') { if (tryCallRender(v.default, `window.${k}.default`)) return true; }
        }
      }
      for (const root of wins){
        if (!root) continue;
        for (const k of cands){
          const v = root[k];
          if (!v) continue;
          if (typeof v === 'function') { if (tryRenderComponent(v, `window.${k}`)) return true; }
          if (v && typeof v === 'object' && typeof v.default === 'function') { if (tryRenderComponent(v.default, `window.${k}.default`)) return true; }
        }
      }
      logErr('Could not auto-detect a render function or component. GUI did not mount.');
      log('window keys snapshot (filtered):', Object.keys(window).filter(k=>/gui|scratch|GUI|App/i.test(k)).join(', ') || '(none)');
      return false;
    }

    const s = document.createElement('script');
    s.src = 'scratch-gui.js?v=stable-alt-boot';
    s.onload = () => { log('GUI script loaded'); setTimeout(mountGUI, 0); };
    s.onerror = () => logErr('Failed to load scratch-gui.js');
    document.head.appendChild(s);
  })();
  </script>
</head>
<body>
  <div id="app"></div>
</body>
</html>
