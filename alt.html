<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SASC Scratch Editor — alt (v6)</title>

  <script src="https://unpkg.com/react@16.14.0/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@16.14.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/redux@4.2.1/dist/redux.min.js"></script>

  <style>
    html,body,#root{height:100%;margin:0}
    #root{display:flex}
    #sasc-console{position:fixed;left:10px;bottom:10px;width:360px;height:180px;z-index:99999;background:rgba(0,0,0,.8);color:#0f0;font:12px/1.35 monospace;border:1px solid #333;border-radius:8px;box-shadow:0 0 10px rgba(0,0,0,.4);display:flex;flex-direction:column;overflow:hidden}
    #sasc-console header{padding:6px 8px;background:#111;color:#9cf}
    #sasc-console pre{flex:1;margin:0;padding:6px 8px;white-space:pre-wrap;overflow:auto}
    #sasc-console button{all:unset;cursor:pointer;color:#9cf;margin-left:auto}
  </style>
</head>
<body>
  <div id="root"></div>

  <div id="sasc-console" aria-live="polite">
    <header><strong>SASC</strong> <button id="sasc-clear">clear</button></header>
    <pre></pre>
  </div>

  <script>
    (function bootstrap(){
      const pre = document.querySelector('#sasc-console pre');
      const log = (...a)=>{ try{ pre.textContent += a.join(' ')+'\n'; pre.scrollTop = pre.scrollHeight; }catch{}; console.log(...a); };
      const logErr = (...a)=>{ try{ pre.textContent += a.join(' ')+'\n'; pre.scrollTop = pre.scrollHeight; }catch{}; console.error(...a); };
      document.getElementById('sasc-clear').onclick = ()=>{ pre.textContent=''; };

      if (window.React && !window.react) window.react = window.React, log('react alias set');
      if (window.ReactDOM && !window['react-dom']) window['react-dom'] = window.ReactDOM, log('react-dom alias set');
      if (window.Redux && !window.redux) window.redux = window.Redux, log('redux alias set');

      log('href:', location.href);
      log('React present:', !!window.React, 'version:', window.React && window.React.version);
      log('ReactDOM present:', !!window.ReactDOM);
      log('Redux present:', !!window.Redux);

      const basePath = location.pathname.replace(/\/[^/]*$/, '/');
      const ownerRepo = basePath.split('/').filter(Boolean).slice(0,2);
      const repoRoot = '/' + ownerRepo.join('/');
      const withRepo = p => (repoRoot + '/' + p.replace(/^\/+/, '')).replace(/\/{2,}/g,'/');

      function rewriteToLocal(url) {
        try {
          const u = new URL(url, location.href);
          if (/^\/libraries\//.test(u.pathname) || /^\/(static|chunks)\//.test(u.pathname)) {
            u.pathname = withRepo(u.pathname);
            return u.toString();
          }
          return url;
        } catch { return url; }
      }
      function localAssetURLForInternalAPI(url) {
        try {
          const u = new URL(url, location.href);
          const m = u.pathname.match(/internalapi\/asset\/([^/]+\.(?:sprite3|json|svg))\/get/i);
          if (m) return withRepo('static/assets/' + m[1]);
        } catch {}
        return null;
      }

      (function installFetch(){
        if (window.__sascFetchHookInstalled) return;
        window.__sascFetchHookInstalled = true;
        const ofetch = window.fetch.bind(window);
        window.fetch = async function(input, init){
          const origURL = (typeof input === 'string') ? input : (input && input.url);
          let url = origURL;
          url = rewriteToLocal(url);
          const localAsset = localAssetURLForInternalAPI(origURL || '');
          if (localAsset) {
            const mm = (origURL||'').match(/internalapi\/asset\/([^/]+\.(?:sprite3|json|svg))\/get/i);
            if (mm) log('[ASSET REQUEST]', mm[1], '←', origURL);
            try {
              const r = await ofetch(localAsset, init);
              if (r && r.ok) return r;
            } catch(e){}
            return ofetch(origURL, init);
          }
          return ofetch(url, init);
        };
        log('[fetch hook] installed');
      })();

      (function installXHR(){
        if (window.__sascXHRHookInstalled) return;
        window.__sascXHRHookInstalled = true;
        const oopen = XMLHttpRequest.prototype.open;
        XMLHttpRequest.prototype.open = function(method, url){
          const mapped = rewriteToLocal(url);
          const localAsset = localAssetURLForInternalAPI(url);
          const finalURL = localAsset || mapped;
          return oopen.apply(this, [method, finalURL]);
        };
        log('[xhr hook] installed');
      })();

      window.addEventListener('unhandledrejection', ev => {
        logErr('[unhandledrejection]:', ev.reason && (ev.reason.stack || ev.reason.toString()));
      });

      const s = document.createElement('script');
      s.src = 'scratch-gui.js?v=stable-boot-v6_' + Date.now();
      s.defer = true;
      s.onload = () => {
        log('GUI script loaded');
        try {
          const GUI = (window.GUI && window.GUI.default) || window.GUI;
          const AppStateHOC = window.GUI && window.GUI.AppStateHOC;
          if (!GUI || !AppStateHOC) throw new Error('Could not find GUI or AppStateHOC');
          const Root = AppStateHOC(GUI);
          const rootEl = document.getElementById('root');
          rootEl.setAttribute('aria-hidden','false');
          window.ReactDOM.render(window.React.createElement(Root, {}), rootEl);
          log('Mounted via GUI.AppStateHOC(GUI)');
        } catch (e) {
          logErr('Mount failed:', e && (e.stack || e.toString()));
        }
      };
      s.onerror = () => logErr('Failed to load scratch-gui.js');
      document.head.appendChild(s);
    })();
  </script>

</body>
</html>
