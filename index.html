<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="google" value="notranslate" />
    <link rel="shortcut icon" href="static/favicon.ico" />
    <title>Scratch 3.0 GUI â€” SA SchoolCoding</title>

    <!-- Main editor bundle -->
    <script defer src="gui.js"></script>

    <!-- Force official asset/project hosts + log failed fetches -->
    <script>
    (function(){
      function setStorageHosts(){
        try{
          const vm = window.vm;
          const st = vm && vm.runtime && vm.runtime.storage;
          if (st) {
            if (typeof st.setAssetHost   === 'function') st.setAssetHost('https://assets.scratch.mit.edu');
            if (typeof st.setProjectHost === 'function') st.setProjectHost('https://projects.scratch.mit.edu');
            st.assetHost   = 'https://assets.scratch.mit.edu';
            st.projectHost = 'https://projects.scratch.mit.edu';
          }
        } catch(e) { console.warn('SASC storage host patch skipped:', e); }
      }

      // Log failed fetches so we can see exact status/URL if anything breaks
      (function hookFetch(){
        const orig = window.fetch;
        if (!orig) return;
        window.fetch = function(url, opts){
          return orig.call(this, url, opts).then(res => {
            if (!res.ok) console.warn('Asset fetch failed:', res.status, res.url);
            return res;
          }).catch(err => {
            console.error('Asset fetch error:', url, err);
            throw err;
          });
        };
      })();

      // Try immediately and again after VM has initialized
      window.addEventListener('load', () => {
        setStorageHosts();
        setTimeout(setStorageHosts, 800);
      });
    })();
    </script>

    <!-- Autosave/restore bridge (localStorage) -->
    <script>
    (function () {
      const KEY = "sasc_autosave";
      const SAVE_MS = 10000;

      function getVM() {
        try {
          return window.vm && typeof window.vm.toJSON === "function" ? window.vm : null;
        } catch (_) { return null; }
      }

      function tryRestore() {
        try {
          const vm = getVM();
          if (!vm) return false;
          const saved = localStorage.getItem(KEY);
          if (saved) vm.loadProject(saved);
          return true;
        } catch (_) { return false; }
      }

      function startAutoSave() {
        try {
          const vm = getVM();
          if (!vm) return false;
          if (window.__sascSaver) return true; // guard against duplicates
          window.__sascSaver = setInterval(() => {
            try {
              const v = getVM(); if (!v) return;
              const json = v.toJSON();
              localStorage.setItem(KEY, json);
            } catch (_) {}
          }, SAVE_MS);
          return true;
        } catch (_) { return false; }
      }

      // Wait until the page (and gui.js) are loaded, then poll for VM
      function tick() {
        if (tryRestore() & startAutoSave()) return;
        setTimeout(tick, 500);
      }
      window.addEventListener("load", tick);
    })();
    </script>

    <style>
      html, body { height: 100%; margin: 0; }
      body { overflow: hidden; background: #0f0f0f; }
    </style>
  </head>
  <body></body>
</html>
