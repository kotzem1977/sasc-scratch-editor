<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SASC Scratch Editor — index (v8)</title>
  <style>
    html,body,#app{height:100%;margin:0}
    #app{display:flex;align-items:stretch;justify-content:stretch;background:#0b1120}
    /* SASC console overlay */
    #sasc-console{position:fixed;left:10px;bottom:10px;width:320px;max-height:45vh;background:#111a;backdrop-filter:blur(2px);
      color:#0ff;font:12px/1.35 ui-monospace,Consolas,monospace;border:1px solid #044;border-radius:8px;z-index:99999}
    #sasc-console header{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:#022;border-bottom:1px solid #044;border-radius:8px 8px 0 0}
    #sasc-console pre{margin:0;padding:6px 8px;white-space:pre-wrap;overflow:auto;max-height:calc(45vh - 32px)}
    #sasc-console button{all:unset;cursor:pointer;color:#0ff;padding:2px 6px;border:1px solid #044;border-radius:6px}
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- React 16.14 UMD -->
  <script src="https://unpkg.com/react@16.14.0/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@16.14.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/redux@4.2.1/dist/redux.min.js"></script>

  <!-- alias shim -->
  <script>
    (function(){
      if (window.React && !window.react)      { window.react = window.React;      console.log('[SASC] react alias set');}
      if (window.ReactDOM && !window['react-dom']) { window['react-dom'] = window.ReactDOM; console.log('[SASC] react-dom alias set');}
      if (window.Redux && !window.redux)      { window.redux = window.Redux;      console.log('[SASC] redux alias set');}
      console.log('[SASC] href:', location.href);
      console.log('[SASC] React present:', !!window.React, 'version:', window.React && window.React.version);
      console.log('[SASC] ReactDOM present:', !!window.ReactDOM);
      console.log('[SASC] Redux present:', !!window.Redux);
    })();
  </script>

  <!-- SASC console -->
  <div id="sasc-console">
    <header>
      <strong>SASC</strong>
      <div>
        <button onclick="(document.querySelector('#sasc-console pre').textContent='SASC clear\n')">Clear</button>
      </div>
    </header>
    <pre>SASC clear
</pre>
  </div>
  <script>
    (function(){
      const pre = document.querySelector('#sasc-console pre');
      window.__sascLog = (m)=>{ try{ pre.textContent += m+'\n'; pre.scrollTop = pre.scrollHeight; }catch(_){} console.log(m); };
      window.addEventListener('click', e => __sascLog('[Click] ' + e.target.tagName));
      window.addEventListener('unhandledrejection', e => __sascLog('[unhandledrejection]: ' + (e.reason && (e.reason.stack || e.reason))));
    })();
  </script>

  <!-- fetch/xhr asset hooks (log + local-first) -->
  <script>
    (function(){
      const base = location.pathname.replace(/\/[^/]*$/, '/'); // /<user>/<repo>/
      const repoRoot = base.replace(/\/$/, '');
      const toLocalAsset = (u) => {
        // Only rewrite the Scratch asset CDN → our /static/assets/
        const m = u.match(/internalapi\/asset\/([a-f0-9]{32}\.(?:sprite3|json|svg|png|gif|jpg))\/get\/?/i);
        if (m) return repoRoot + '/static/assets/' + m[1];
        return null;
      };

      // fetch hook
      const f = window.fetch;
      window.fetch = async function(input, init){
        const url = (typeof input === 'string') ? input : (input && input.url);
        const local = url && toLocalAsset(url);
        if (local){
          __sascLog('[fetch] local-first: ' + local + ' (← ' + url + ')');
          const r = await f(local, init).catch(()=>null);
          if (r && r.ok) return r;
        }
        return f.apply(this, arguments);
      };
      __sascLog('[fetch hook] installed (libraries untouched, assets local-first)');

      // XHR hook
      const XO = XMLHttpRequest;
      window.XMLHttpRequest = function(){
        const x = new XO();
        const op = x.open;
        x.open = function(method, url){
          const local = typeof url === 'string' ? toLocalAsset(url) : null;
          if (local){
            __sascLog('[xhr] local-first: ' + local + ' (← ' + url + ')');
            return op.call(x, method, local);
          }
          return op.apply(x, arguments);
        };
        return x;
      };
      __sascLog('[xhr hook] installed (assets local-first)');
    })();
  </script>

  <!-- Scratch GUI bundle from your repo -->
  <script src="scratch-gui.js?v=stable-boot-v8"></script>

  <!-- Mount with full HOC chain + setModalAppElement -->
  <script>
    (function boot(){
      try{
        const app = document.getElementById('app');

        // react-modal needs this to hide background to screen readers when dialogs open
        if (window.GUI && typeof window.GUI.setAppElement === 'function'){
          window.GUI.setAppElement(app);
        }

        // Compose HOCs to match Scratch default boot:
        // HashParserHOC(ProjectLoaderHOC(AppStateHOC(GUI)))
        const GUI = window.GUI;
        let Wrapped = GUI.default || GUI.GUI || GUI;
        Wrapped = GUI.AppStateHOC(Wrapped);
        Wrapped = GUI.ProjectLoaderHOC ? GUI.ProjectLoaderHOC(Wrapped) : Wrapped;
        Wrapped = GUI.HashParserHOC ? GUI.HashParserHOC(Wrapped) : Wrapped;

        // Render editor (not player-only)
        const el = window.React.createElement(Wrapped, {
          isPlayerOnly: false,
          isFullScreen: false,
          canUseCloud: false
        });

        window.ReactDOM.render(el, app);
        __sascLog('GUI mounted via HashParser(ProjectLoader(AppState(GUI)))');
      }catch(e){
        __sascLog('BOOT ERROR: ' + (e.stack || e));
        console.error(e);
      }
    })();
  </script>
</body>
</html>
