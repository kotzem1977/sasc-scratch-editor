<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="google" value="notranslate" />
  <link rel="shortcut icon" href="static/favicon.ico" />
  <title>Scratch 3.0 GUI — SA SchoolCoding</title>

  <!-- Hard fetch interceptor: route internalapi assets to local static/assets/<md5ext> -->
  <script>
  (function () {
    const origFetch = window.fetch && window.fetch.bind(window);
    if (!origFetch) return;

    // e.g. /internalapi/asset/3826a4091a33e4d26f87a2fac7cf796b.svg/get/
    const INTERNAL_ASSET_RE = /\/internalapi\/asset\/([0-9a-f]{32}\.[a-z0-9]+)\/get\/?$/i;

    function isScratchAssetHost(h) {
      return h === 'assets.scratch.mit.edu' || h === 'cdn.assets.scratch.mit.edu';
    }

    function toLocalAssetURL(md5ext) {
      // keep current repo base path (works on /sasc-scratch-editor or any subpath)
      const basePath = location.pathname.replace(/\/[^/]*$/, '/'); // strip filename
      return new URL('static/assets/' + md5ext, location.origin + basePath).toString();
    }

    function rewrite(url) {
      try {
        const u = new URL(url, location.href);

        // Case 1: requests going to Scratch asset hosts
        if (isScratchAssetHost(u.hostname)) {
          const m = u.pathname.match(INTERNAL_ASSET_RE);
          if (m) {
            const local = toLocalAssetURL(m[1]);
            console.log('[ASSET] rewrite from Scratch host →', local);
            return local;
          }
        }

        // Case 2: requests trying YOUR origin for internalapi (some builds do this)
        {
          const m = u.pathname.match(INTERNAL_ASSET_RE);
          if (m) {
            const local = toLocalAssetURL(m[1]);
            console.log('[ASSET] rewrite from internalapi on this origin →', local);
            return local;
          }
        }

        // Case 3: very rare direct MD5EXT fetches — leave them as-is (already local)
        return url;
      } catch (e) {
        return url;
      }
    }

    window.fetch = function (input, init) {
      if (typeof input === 'string') {
        const newURL = rewrite(input);
        return origFetch(newURL, init).then(r => {
          console.log('[ASSET] fetch', newURL, '→', r.status);
          return r;
        });
      } else if (input && typeof input.url === 'string') {
        const newURL = rewrite(input.url);
        const req = (newURL === input.url) ? input : new Request(newURL, input);
        return origFetch(req, init).then(r => {
          console.log('[ASSET] fetch', newURL, '→', r.status);
          return r;
        });
      }
      return origFetch(input, init);
    };
  })();
  </script>

  <!-- Scratch GUI bundle (the one you already published) -->
  <script defer src="scratch-gui.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }
    body { overflow: hidden; background: #111; }
  </style>
</head>
<body></body>
</html>
