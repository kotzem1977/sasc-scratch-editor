<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="google" value="notranslate"/>
  <link rel="shortcut icon" href="static/favicon.ico"/>
  <title>Scratch 3.0 GUI — SA SchoolCoding</title>
  <!-- SASC v3 -->

  <!-- Known-good UMDs -->
  <script src="https://unpkg.com/react@16.14.0/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@16.14.0/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/redux@4.2.1/dist/redux.min.js" crossorigin></script>

  <style>
    html,body{height:100%;margin:0}
    body{overflow:hidden;background:#0f0f0f}
    #app{height:100%}
    #sasc-console{
      position:fixed;left:12px;bottom:12px;z-index:99999;
      font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      color:#eee;background:#111;opacity:.95;border:1px solid #333;border-radius:8px;
      max-width:50vw;max-height:30vh;overflow:auto;padding:8px 10px;box-shadow:0 6px 16px rgba(0,0,0,.5)
    }
    #sasc-console b{color:#9ad}
  </style>

  <script>
  (function(){
    function log(){ try{
      const box = document.getElementById('sasc-console');
      if (box) box.innerHTML += Array.from(arguments).map(a=>String(a)).join(' ') + '<br/>';
      console.log('[SASC]', ...arguments);
    }catch(_){}
    }
    // overlay
    const div = document.createElement('div');
    div.id = 'sasc-console';
    div.innerHTML = '<b>[SASC]</b> Console ready<br/>';
    document.addEventListener('click', e => log('[Click]', e.target.tagName));
    if (document.body) document.body.appendChild(div);
    else document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(div));

    // alias shim (some UMDs expect lowercase names)
    if (window.React && !window.react) { window.react = window.React; log('react alias set'); }
    if (window.ReactDOM && !window['react-dom']) { window['react-dom'] = window.ReactDOM; log('react-dom alias set'); }
    if (window.Redux && !window.redux) { window.redux = window.Redux; log('redux alias set'); }

    log('href:', location.href);
    log('React present:', !!window.react, 'version:', window.react && window.react.version);
    log('ReactDOM present:', !!window['react-dom']);
    log('Redux present:', !!window.redux);

    // fetch() rewrite so GUI works under /<user>/<repo>/ subpath + self-hosted assets
    (function(){
      const origFetch = window.fetch && window.fetch.bind(window);
      if (!origFetch) return;
      const basePath = location.pathname.replace(/\/[^/]*$/, '/');      // “…/sasc-scratch-editor/”
      const ownerRepo = basePath.split('/').filter(Boolean).slice(0,2); // ["kotzem1977","sasc-scratch-editor"]
      const repoPath = '/' + ownerRepo.join('/');                        // "/kotzem1977/sasc-scratch-editor"

      function toLocal(urlStr){
        const u = new URL(urlStr, location.origin + basePath);

        // libraries JSON (sprites/backdrops/etc.) must come from the repo
        if (u.pathname.startsWith('/libraries/')) {
          u.pathname = (repoPath + u.pathname).replace(/\/{2,}/g,'/');
        }
        // static + chunks should resolve under current basePath
        else if (u.pathname.startsWith('/static/') || u.pathname.startsWith('/chunks/')) {
          u.pathname = (basePath.replace(/\/$/, '') + u.pathname).replace(/\/{2,}/g,'/');
        }
        // internalapi → self-hosted assets
        else if (u.pathname.startsWith('/internalapi/asset/')) {
          const m = u.pathname.match(/^\/internalapi\/asset\/([^/]+)\/get\/?$/);
          if (m) u.pathname = (basePath + 'static/assets/' + m[1]).replace(/\/{2,}/g,'/');
        } else if (u.pathname.startsWith('internalapi/asset/')) {
          const m = u.pathname.match(/^internalapi\/asset\/([^/]+)\/get\/?$/);
          if (m) u.pathname = (basePath + 'static/assets/' + m[1]).replace(/\/{2,}/g,'/');
        }

        return u.toString();
      }

      window.fetch = function(input, init){
        try{
          if (typeof input === 'string') {
            const fixed = toLocal(input);
            if (fixed !== input) console.log('[SASC fetch]', input, '→', fixed);
            return origFetch(fixed, init);
          } else if (input && typeof input.url === 'string') {
            const fixed = toLocal(input.url);
            if (fixed !== input.url) {
              console.log('[SASC fetch]', input.url, '→', fixed);
              input = new Request(fixed, input);
            }
            return origFetch(input, init);
          }
        }catch(e){ console.warn('[SASC fetch] rewrite error', e); }
        return origFetch(input, init);
      };
    })();
  })();
  </script>

  <!-- Load your built Scratch GUI bundle -->
  <script defer src="scratch-gui.js?v=stable"></script>
</head>
<body>
  <div id="app"></div>
</body>
</html>
