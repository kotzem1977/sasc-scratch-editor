<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="google" value="notranslate" />
    <link rel="shortcut icon" href="static/favicon.ico" />
    <title>Scratch 3.0 GUI — SA SchoolCoding</title>

    <script>
      // Small bubble for crash messages (helps avoid "black screen")
      (function(){
        function bubble(msg){
          try{
            const d=document.createElement('div');
            d.style.cssText='position:fixed;left:8px;bottom:8px;max-width:96%;z-index:99999;background:#2b2b2b;color:#fff;padding:10px 12px;border-radius:8px;font:12px/1.4 system-ui,Segoe UI,Arial';
            d.textContent='[Bootstrap] '+msg;
            document.documentElement.appendChild(d);
          }catch(_){}
        }
        window.addEventListener('error', e => bubble(e.message||'script error'));
        window.addEventListener('unhandledrejection', e => bubble((e.reason && (e.reason.message||String(e.reason))) || 'promise rejection'));
        window.__bubbleError = bubble;
      })();
    </script>

    <script>
      // Local-first asset shim with verbose logging
      (function(){
        if (!window.fetch) return;
        const origFetch = window.fetch.bind(window);

        const basePath = location.pathname.replace(/\/[^/]*$/, '/');
        const ABS_BASE = new URL(basePath, location.origin).toString();
        const LOCAL_ASSET_PREFIX = new URL('./static/assets/', ABS_BASE).toString();

        const SUBPATH_PREFIXES = ['/static/', '/chunks/'];
        const LIB_JSON = /^\/libraries\/(sprites|backdrops|costumes|sounds)\.json$/;

        // The two asset ids we’ve published locally
        const LOCAL_PINNED = new Set([
          '3826a4091a33e4d26f87a2fac7cf796b.svg', // Apple
          'e7c147730f19d284bcd7b3f00af19bb6.svg'  // Blue Sky
        ]);

        function urlOf(input){
          try{
            return (typeof input==='string')
              ? new URL(input, location.href)
              : (input && typeof input.url==='string' ? new URL(input.url, location.href) : null);
          }catch{ return null; }
        }
        function isLibJson(u){ return !!(u && LIB_JSON.test(u.pathname)); }
        function needsSubpathRewrite(u){ return !!(u && SUBPATH_PREFIXES.some(p => u.pathname.startsWith(p))); }
        function toProjectURL(u){
          const rel = u.pathname.replace(/^\//,'') + (u.search||'') + (u.hash||'');
          return new URL(rel, ABS_BASE).toString();
        }
        function extractMd5ext(u){
          if (!u) return null;
          // internalapi/asset/<md5ext>/get/
          let m = u.pathname.match(/\/internalapi\/asset\/([0-9a-f]{32}\.[a-z0-9]+)\/get\/?$/i);
          if (m) return m[1];
          // /static/assets/<md5ext>
          m = u.pathname.match(/\/static\/assets\/([0-9a-f]{32}\.[a-z0-9]+)$/i);
          if (m) return m[1];
          return null;
        }

        function localURL(md5ext){ return LOCAL_ASSET_PREFIX + md5ext; }
        async function tryLocalThenRemote(init, md5ext){
          const local = localURL(md5ext);
          console.log('[ASSET]', md5ext, '→ try local', local);
          if (local) {
            const r = await origFetch(local, init);
            console.log('[ASSET]', md5ext, 'local status', r.status);
            if (r.ok) return r;
          }
          const remote = `https://assets.scratch.mit.edu/internalapi/asset/${md5ext}/get/`;
          console.log('[ASSET]', md5ext, '→ fallback remote', remote);
          return origFetch(remote, init);
        }

        window.fetch = async function(input, init){
          const u = urlOf(input);

          // libraries/*.json should come from our repo (subpath-safe)
          if (isLibJson(u)) {
            const libURL = toProjectURL(u);
            console.log('[LIB]', u.href, '→', libURL);
            return (typeof input==='string') ? origFetch(libURL, init)
                                             : origFetch(new Request(libURL, input), init);
          }

          // subpath-safe static & chunks
          if (needsSubpathRewrite(u)) {
            const projURL = toProjectURL(u);
            // be quiet for noisy static/chunks
            return (typeof input==='string') ? origFetch(projURL, init)
                                             : origFetch(new Request(projURL, input), init);
          }

          // Intercept any asset request by md5ext
          const md5ext = extractMd5ext(u);
          if (md5ext) {
            // Force our two known assets to local only
            if (LOCAL_PINNED.has(md5ext)) {
              const forced = localURL(md5ext);
              console.log('[ASSET]', md5ext, 'FORCED local', forced);
              const req = (typeof input==='string') ? forced : new Request(forced, input);
              return origFetch(req, init);
            }
            // Others: local -> remote fallback
            return tryLocalThenRemote(init, md5ext);
          }

          return origFetch(input, init);
        };
      })();
    </script>

    <!-- Fully bundled GUI (includes React etc.) -->
    <script defer src="gui.js" onerror="__bubbleError && __bubbleError('gui.js failed to load')"></script>

    <style>
      html, body { height: 100%; margin: 0; }
      body { overflow: hidden; background: #0f0f0f; }
    </style>
  </head>
  <body></body>
</html>
