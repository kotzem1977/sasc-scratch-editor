<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SASC Scratch Editor — index (v9)</title>
  <style>
    html,body,#app{height:100%;margin:0}
    #app{display:flex;align-items:stretch;justify-content:stretch;background:#0b1120}
    /* SASC console overlay */
    #sasc-console{position:fixed;left:10px;bottom:10px;width:320px;max-height:45vh;background:#111a;backdrop-filter:blur(2px);
      color:#0ff;font:12px/1.35 ui-monospace,Consolas,monospace;border:1px solid #044;border-radius:8px;z-index:99999}
    #sasc-console header{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:#022;border-bottom:1px solid #044;border-radius:8px 8px 0 0}
    #sasc-console pre{margin:0;padding:6px 8px;white-space:pre-wrap;overflow:auto;max-height:calc(45vh - 32px)}
    #sasc-console button{all:unset;cursor:pointer;color:#0ff;padding:2px 6px;border:1px solid #044;border-radius:6px}
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- SASC console -->
  <div id="sasc-console">
    <header>
      <strong>SASC</strong>
      <div>
        <button onclick="(document.querySelector('#sasc-console pre').textContent='SASC clear\n')">Clear</button>
      </div>
    </header>
    <pre>SASC clear
</pre>
  </div>

  <script>
    // tiny logger into the overlay
    window.__sascLog = function(msg){
      try {
        const z = document.querySelector('#sasc-console pre');
        if (z) z.textContent += (msg + '\n');
      } catch(_) {}
      console.log('[SASC]', msg);
    };
    __sascLog('overlay ready');
  </script>

  <!-- React 16.14 UMD (aliases for older UMD expectations) -->
  <script src="https://unpkg.com/react@16.14.0/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@16.14.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/redux@4.2.1/dist/redux.min.js"></script>
  <script>
    (function(){
      if (window.React && !window.react)            { window.react = window.React;            __sascLog('react alias set');}
      if (window.ReactDOM && !window['react-dom'])  { window['react-dom'] = window.ReactDOM;  __sascLog('react-dom alias set');}
      if (window.Redux && !window.redux)            { window.redux = window.Redux;            __sascLog('redux alias set');}
      __sascLog('href: ' + location.href);
      __sascLog('React present: ' + !!window.React + ' version: ' + (window.React && window.React.version));
      __sascLog('ReactDOM present: ' + !!window.ReactDOM);
      __sascLog('Redux present: ' + !!window.Redux);
    })();
  </script>

  <!-- Load the Scratch GUI bundle; adjust the src if your file lives elsewhere -->
  <script id="gui-bundle"
          src="scratch-gui.js?v=umd-boot-{{DATE}}"
          onload="window.__sascLog('GUI bundle loaded'); (function boot(){
            try{
              const app = document.getElementById('app');
              const GUI = window.GUI;

              if (!GUI) { window.__sascLog('ERROR: window.GUI is missing even after script load'); return; }

              // Fix react-modal warning (and accessibility)
              if (typeof GUI.setAppElement === 'function') GUI.setAppElement(app);

              if (typeof GUI.render === 'function') {
                GUI.render(app); // canonical boot path if provided by your UMD
                window.__sascLog('GUI mounted via GUI.render(app)');
                return;
              }

              // Compose HOCs and force default project if no id is in the hash
              let Wrapped = GUI.default || GUI.GUI || GUI;
              if (typeof GUI.AppStateHOC === 'function') Wrapped = GUI.AppStateHOC(Wrapped);
              if (typeof GUI.ProjectLoaderHOC === 'function') Wrapped = GUI.ProjectLoaderHOC(Wrapped);
              if (typeof GUI.HashParserHOC === 'function') Wrapped = GUI.HashParserHOC(Wrapped);

              const props = {
                isPlayerOnly: false,
                isFullScreen: false,
                canUseCloud: false,
                projectId: (location.hash && /\\d+/.test(location.hash)) ? undefined : '0'
              };

              const el = window.React.createElement(Wrapped, props);
              window.ReactDOM.render(el, app);
              window.__sascLog('GUI mounted via HashParser(ProjectLoader(AppState(GUI))) with projectId=' + props.projectId);

              // Wait until VM has targets before interacting (prevents ‘variables’ error)
              const timer = setInterval(() => {
                try {
                  const vm = window.vm || (GUI && GUI.vm);
                  if (vm && vm.runtime && vm.runtime.targets && vm.runtime.targets.length) {
                    window.__sascLog('[VM] ready: ' + vm.runtime.targets.length + ' targets');
                    clearInterval(timer);
                  }
                } catch(_) {}
              }, 250);
              setTimeout(()=>clearInterval(timer), 15000);
            }catch(e){
              window.__sascLog('BOOT ERROR: ' + (e && e.message));
              console.error(e);
            }
          })();"
          onerror="window.__sascLog('ERROR: failed to load scratch-gui.js (check the path)');">
  </script>
</body>
</html>
