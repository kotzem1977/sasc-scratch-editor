<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="google" value="notranslate" />
    <link rel="shortcut icon" href="static/favicon.ico" />
    <title>Scratch 3.0 GUI â€” SA SchoolCoding</title>

    <!-- Subpath + library fetch fixer -->
    <script>
    (function(){
      const origFetch = window.fetch;
      if (!origFetch) return;

      // Project info (edit if you ever rename the repo/branch)
      const OWNER  = 'kotzem1977';
      const REPO   = 'sasc-scratch-editor';
      const BRANCH = 'main';

      // e.g. /sasc-scratch-editor/index.html -> /sasc-scratch-editor/
      const basePath = location.pathname.replace(/\/[^/]*$/, '/');

      // Prefixes the GUI requests as root-relative paths
      const SUBPATH_PREFIXES = ['/static/', '/chunks/'];

      // Match /libraries/*.json exactly
      const LIB_JSON = /^\/libraries\/(sprites|backdrops|costumes|sounds)\.json$/;

      function needsSubpathRewrite(u) {
        return typeof u === 'string' && SUBPATH_PREFIXES.some(p => u.startsWith(p));
      }

      function toProjectURL(u) {
        const rel = u.replace(/^\//, '');
        return new URL(rel, location.origin + basePath).toString();
      }

      function maybeLibraryRawURL(u) {
        if (typeof u !== 'string') return null;
        const m = u.match(LIB_JSON);
        if (!m) return null;
        const file = m[0].replace(/^\//, ''); // libraries/xxx.json
        // Raw GitHub URL (CORS: *)
        return `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${file}`;
      }

      window.fetch = function(u, opts){
        // 1) If it's a library JSON, rewrite to raw GitHub
        const rawLib = maybeLibraryRawURL(u);
        if (rawLib) {
          return origFetch.call(this, rawLib, opts);
        }
        // 2) Fix root-relative subpaths (/static, /chunks) to project subpath
        if (needsSubpathRewrite(u)) {
          return origFetch.call(this, toProjectURL(u), opts);
        }
        // 3) Everything else as-is
        return origFetch.call(this, u, opts);
      };
    })();
    </script>

    <!-- Main editor bundle -->
    <script defer src="gui.js"></script>

    <style>
      html, body { height: 100%; margin: 0; }
      body { overflow: hidden; background: #0f0f0f; }
    </style>
  </head>
  <body></body>
</html>
