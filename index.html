<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SASC Scratch Editor — index (v9)</title>
  <style>
    html,body,#app{height:100%;margin:0}
    #app{display:flex;align-items:stretch;justify-content:stretch;background:#0b1120}
    /* SASC console overlay */
    #sasc-console{position:fixed;left:10px;bottom:10px;width:320px;max-height:45vh;background:#111a;backdrop-filter:blur(2px);
      color:#0ff;font:12px/1.35 ui-monospace,Consolas,monospace;border:1px solid #044;border-radius:8px;z-index:99999}
    #sasc-console header{display:flex;justify-content:space-between;align-items:center;padding:6px 8px;background:#022;border-bottom:1px solid #044;border-radius:8px 8px 0 0}
    #sasc-console pre{margin:0;padding:6px 8px;white-space:pre-wrap;overflow:auto;max-height:calc(45vh - 32px)}
    #sasc-console button{all:unset;cursor:pointer;color:#0ff;padding:2px 6px;border:1px solid #044;border-radius:6px}
  </style>
</head>
<body>
  <div id="app"></div>

  <!-- SASC console -->
  <div id="sasc-console">
    <header>
      <strong>SASC</strong>
      <div>
        <button onclick="(document.querySelector('#sasc-console pre').textContent='SASC clear\n')">Clear</button>
      </div>
    </header>
    <pre>SASC clear
</pre>
  </div>

  <!-- SASC: asset request logger + resilient local-first fetch -->
<script>
(function installSascAssetHook(){
  if (window.__sascFetchHookInstalled) return;
  window.__sascFetchHookInstalled = true;

  const log = (m)=>{ try{const p=document.querySelector('#sasc-console pre'); if(p) p.textContent += m+'\n';}catch(_){} console.log('[SASC]', m); };

  // Build our local-first order for any internalapi/asset/<md5.ext>/get/ URL
  function rewriteAssetURL(urlStr){
    try{
      const u = new URL(urlStr, location.href);
      const m = u.pathname.match(/internalapi\/asset\/([^/]+\.(?:sprite3|json|svg|png|gif|jpg))\/get\/?$/i);
      if (!m) return [urlStr]; // not an asset URL → return original only
      const md5ext = m[1];

      // Our preferred order:
      // 1) Local mirror (if present)
      const base = location.pathname.replace(/\/[^/]*$/, '/'); // …/<repo>/
      const local = base.replace(/\/$/, '') + '/static/assets/' + md5ext;

      // 2) Primary Scratch CDN
      const primary = 'https://assets.scratch.mit.edu/internalapi/asset/'+md5ext+'/get/';

      // 3) Secondary Scratch CDN
      const secondary = 'https://cdn.assets.scratch.mit.edu/internalapi/asset/'+md5ext+'/get/';

      return [local, primary, secondary];
    }catch(_){ return [urlStr]; }
  }

  async function tryFetchChain(original, init){
    const chain = rewriteAssetURL(original);
    const md5ext = (function(){
      const m = String(original).match(/internalapi\/asset\/([^/]+)\/get/); return m && m[1];
    })();
    if (md5ext) log('[ASSET REQUEST] ' + md5ext + ' ← ' + original);

    for (let i=0; i<chain.length; i++){
      const u = chain[i];
      try{
        const r = await window.__sasc_ofetch(u, init);
        if (r && r.ok) {
          if (i>0) log('[ASSET FALLBACK OK] ' + u);
          return r;
        }
        log('[ASSET NOT OK '+r.status+'] ' + u);
      }catch(e){
        log('[ASSET ERROR] ' + u + ' :: ' + e);
      }
    }
    // Last resort: do the original so the error surfaces upstream
    return window.__sasc_ofetch(original, init);
  }

  // Hook fetch
  window.__sasc_ofetch = window.fetch.bind(window);
  window.fetch = function(input, init){
    const url = (typeof input === 'string') ? input : (input && input.url);
    if (url && /internalapi\/asset\//i.test(url)) {
      return tryFetchChain(url, init);
    }
    return window.__sasc_ofetch(input, init);
  };
  log('[fetch hook] installed (assets local-first)');

  // Hook XHR too (some builds still use it)
  const OXHR = window.XMLHttpRequest;
  function XHR(){
    const x = new OXHR();
    let openURL = null;
    const _open = x.open;
    x.open = function(method, url){
      openURL = url;
      return _open.apply(x, arguments);
    };
    const _send = x.send;
    x.send = function(){
      if (openURL && /internalapi\/asset\//i.test(openURL)) {
        const chain = rewriteAssetURL(openURL);
        let idx = 0;
        const tryOne = ()=>{
          const u = chain[idx++];
          if (!u) return _send.apply(x, arguments); // give up → original
          _open.call(x, 'GET', u);
          x.addEventListener('load', function onloadOnce(){
            x.removeEventListener('load', onloadOnce);
            if (x.status >= 200 && x.status < 300) {
              if (idx>1) log('[ASSET FALLBACK OK] ' + u);
            } else {
              log('[ASSET NOT OK '+x.status+'] ' + u);
              tryOne();
            }
          });
          _send.apply(x, arguments);
        };
        tryOne();
        return; // handled
      }
      return _send.apply(x, arguments);
    };
    return x;
  }
  window.XMLHttpRequest = XHR;
  log('[xhr hook] installed (assets local-first)');

})();
</script>

</body>
</html>
