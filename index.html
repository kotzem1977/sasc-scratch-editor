<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="google" value="notranslate" />
    <link rel="shortcut icon" href="static/favicon.ico" />
    <title>Scratch 3.0 GUI â€” SA SchoolCoding</title>

    <!-- Subpath + library fetch fixer: keep /static, /chunks and /libraries working from /sasc-scratch-editor/ -->
    <script>
    (function(){
      const origFetch = window.fetch && window.fetch.bind(window);
      if (!origFetch) return;

      const basePath = location.pathname.replace(/\/[^/]*$/, '/');
      const SUBPATH_PREFIXES = ['/static/', '/chunks/'];
      const LIB_JSON = /^\/libraries\/(sprites|backdrops|costumes|sounds)\.json$/;

      function needsSubpathRewrite(u) {
        return typeof u === 'string' && SUBPATH_PREFIXES.some(p => u.startsWith(p));
      }
      function toProjectURL(u) {
        const rel = u.replace(/^\//, '');
        return new URL(rel, location.origin + basePath).toString();
      }
      function maybeLibraryRawURL(u) {
        if (typeof u !== 'string') return null;
        const m = u.match(LIB_JSON);
        if (!m) return null;
        const file = m[0].replace(/^\//, '');
        return new URL(file, location.origin + basePath).toString();
      }

      window.fetch = function(u, opts){
        const lib = maybeLibraryRawURL(u);
        if (lib) return origFetch.call(this, lib, opts);
        if (needsSubpathRewrite(u)) return origFetch.call(this, toProjectURL(u), opts);
        return origFetch.call(this, u, opts);
      };
    })();
    </script>

    <!-- Local-first md5ext asset hook: try /static/assets/<md5ext> first, else fallback to Scratch CDN -->
    <script>
    (function(){
      const origFetch = window.fetch && window.fetch.bind(window);
      if (!origFetch) return;

      const LOCAL_PREFIX = new URL('./static/assets/', location.href).toString();

      function toLocal(md5ext) {
        return /^[0-9a-f]{32}\.[a-z0-9]+$/i.test(md5ext) ? (LOCAL_PREFIX + md5ext) : null;
      }

      function rewrite(url) {
        try {
          const u = new URL(url, location.href);
          // /internalapi/asset/<md5ext>/get/
          const m1 = u.pathname.match(/\/internalapi\/asset\/([0-9a-f]{32}\.[a-z0-9]+)\/get\/?$/i);
          if (m1) return { md5ext: m1[1] };
          // Any bare md5ext on our origin (rare but safe)
          const m2 = u.pathname.match(/\/([0-9a-f]{32}\.[a-z0-9]+)$/i);
          if (m2 && (u.hostname === location.hostname || u.pathname.startsWith('/static/assets/'))) {
            return { md5ext: m2[1] };
          }
        } catch(_){}
        return null;
      }

      async function tryLocalThenRemote(init, md5ext) {
        const localURL  = toLocal(md5ext);
        if (localURL) {
          const resLocal = await origFetch(localURL, init);
          if (resLocal.ok) return resLocal;
        }
        const remoteURL = `https://assets.scratch.mit.edu/internalapi/asset/${md5ext}/get/`;
        return origFetch(remoteURL, init);
      }

      window.fetch = async function(input, init) {
        if (typeof input === 'string') {
          const r = rewrite(input);
          if (r?.md5ext) return tryLocalThenRemote(init, r.md5ext);
          return origFetch(input, init);
        } else if (input && typeof input.url === 'string') {
          const r = rewrite(input.url);
          if (r?.md5ext) return tryLocalThenRemote(init, r.md5ext);
          return origFetch(input, init);
        }
        return origFetch(input, init);
      };
    })();
    </script>

    <!-- Main bundle built from scratch-gui/dist -->
    <script defer src="scratch-gui.js"></script>

    <style>
      html, body { height: 100%; margin: 0; }
      body { overflow: hidden; background: #0f0f0f; }
    </style>
  </head>
  <body></body>
</html>
